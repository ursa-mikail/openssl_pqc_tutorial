#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#include <openssl/evp.h>
#include <openssl/pem.h>
#include <openssl/err.h>
#include <openssl/core_names.h>
#include <openssl/params.h>
#include <openssl/ec.h>

static void hexdump(const char *label, const unsigned char *buf, size_t len) {
    printf("%s (%zu bytes): ", label, len);
    for (size_t i = 0; i < len; i++) printf("%02X", buf[i]);
    printf("\n");
}

static EVP_PKEY *generate_keys(unsigned char *type) {
 

    EVP_PKEY *pkey = NULL;

    EVP_PKEY_CTX *kctx = EVP_PKEY_CTX_new_from_name(NULL, type, NULL);


    EVP_PKEY_keygen_init(kctx);

    EVP_PKEY_keygen(kctx, &pkey);


    printf("Type: %s\n\n",type);

    uint8_t pub[2592], priv[4896];
    size_t priv_len, pub_len;


    EVP_PKEY_get_octet_string_param(pkey, OSSL_PKEY_PARAM_PRIV_KEY,
                                priv, sizeof(priv), &priv_len);
    EVP_PKEY_get_octet_string_param(pkey, OSSL_PKEY_PARAM_PUB_KEY,
                                pub, sizeof(pub), &pub_len);


    printf("Private key length: [%d]\n",priv_len);
    if (priv_len>500) hexdump("Private key (truncated to 500 bytes):",priv,500);
    else hexdump("Private key:",priv,priv_len);

    printf("\nPublic key length: [%d]\n",pub_len);
    if (pub_len>500) hexdump("Public key (truncated to 500 bytes):",pub,500);
    else hexdump("Private key:",pub,pub_len);



    EVP_PKEY_CTX_free(kctx);
    return pkey;
}

void do_sign(EVP_PKEY *pkey, unsigned char *msg, size_t msg_len,unsigned char *type )
{
    size_t sig_len;
    unsigned char *sig = NULL;
    const OSSL_PARAM params[] = {
        OSSL_PARAM_octet_string("context-string", (unsigned char *)"Context string", 33),
        OSSL_PARAM_END
    };
    EVP_PKEY_CTX *sctx = EVP_PKEY_CTX_new_from_pkey(NULL, pkey, NULL);
    EVP_SIGNATURE *sig_alg = EVP_SIGNATURE_fetch(NULL, type, NULL);

    EVP_PKEY_sign_message_init(sctx, sig_alg, params);

    /* Get size of signature */
    EVP_PKEY_sign(sctx, NULL, &sig_len, msg, msg_len);
    sig = OPENSSL_zalloc(sig_len);
    EVP_PKEY_sign(sctx, sig, &sig_len, msg, msg_len);

    printf("\nMessage: [%s]\n",msg);  
    printf("\nSignature length: [%d]\n",sig_len);  
    if (sig_len>500) hexdump("Signature (truncated to 500 bytes):",sig,500);
    else hexdump("Signature:",sig,sig_len);

    OPENSSL_free(sig);

    EVP_PKEY_CTX_free(sctx);
}


int main(int argc, char** argv) {


    ERR_load_crypto_strings();
    OpenSSL_add_all_algorithms();

    unsigned char *type="mldsa87";
    unsigned char *msg="Hello";
    int msg_len=5;

    if (argc > 1) type  =  argv[1];
    if (argc > 2) msg  =  argv[2];

    EVP_PKEY *key = generate_keys(type);
    do_sign(key, msg, strlen(msg),type); 

    return EXIT_SUCCESS;
}

/*
Type: mldsa87

Private key length: [4896]
Private key (truncated to 500 bytes): (500 bytes): ED63340E6E58DF8CD043EF12060DEF6E2BDE502D4038AF0D7368BB402CC9AD543D8E879492AD0A03AB1E361B73DBB3803F154CA1401B8F40CB99053FBCDC7426158C65F7117B81A4204F4AA4F7AD8172F2851EE71808923A89D55C1CF486D7ED1576803D2C4A0257A97A8312203E8709C38B4CB317B41679D9441BF80A2907A889142D8A0029C0080452C220190572A0442ACC360849426D039700938848D13410988681244988E29641C2242D219568A228320193811C128A200545CAA08D424800CC4464421262493244E2302411B68001A24958022E41C2641B8371800605C814025844851A186A44965011A705DB2662C49088E4C02408B16C913008CAA47050449050B8700A8489419021440245E118269306881A414253087001A5880321684A92414800629AA84CDC802D19059019840D14984022B22040C04D133969221912D22864D4146D5922928BA0215BB824CB120C89A67191A40099160014490AC3B20821950524852CD8384C0BA08552461003043280146D100249993201C2326420C08903B14088905112292E1C4160DA1084E0C08D58469282324EC0C400023410540866C04091DC4044D93869243241C8940020394551B889E1908CA3A860582826CAC825CB147010890C6088649B0645503431DB168101A38C11364298184502402C00C26553C4282015914AB63062C050

Public key length: [2592]
Public key (truncated to 500 bytes): (500 bytes): ED63340E6E58DF8CD043EF12060DEF6E2BDE502D4038AF0D7368BB402CC9AD5460D4706F91A75C0DBE6AFA306CCB4EC3742E61A04F1103A134E4071063B0F2FD3D8CA87BEC7CD57BCBA491CAAA894C78EB7626CEB67C86A282D20DB9407232597C8656516FE63602F8E5970E4DF1843EB8FD0247F831FE1CF6D291A2E13E0B46588A6C3561FFF80B2A1C95353C85A9A749CBCC8C23623E2739AAFE68720911044C6B16F745F21857C783B3896FFEC59EC4D20543C8C4D848ABF2B960B4E78FC2244EE06200169F75C048D887116ED1956FCFBA4375EF7F4C73FFC54C5FB186C85B26AA4E85CD3029956387CC0D66ED2446EFB93D50471BA6A538514AC325707BB74CD62C71AA129576538820818B69322DEC630E5340145AB4578C4E0253D0525986FD17517C30487AF4967DA9918039D52D8E76ECA3CAD876FF04461CF7EBD0B3E5AF47004A6BB7D21306405DE3203ABE05A60A13E86F6A1DCBF939410431590D06A84FF47F0C37F10A8B04EDC1337F533FCB19E2E1E14A41284F3C73D0639C53E43CEA5E2AAE138B49B6BEA528D06A195549C0AE64CBD4D2670A3E5AF0DC48EAB907D0269A3CC2ECFD986EB2E84476EA22D2976C8E0A6B12F96738B3F79A60B8895C287E6EB223CE62BF50EA0AC3518E71FE3861823C4987F69E863DE6EC5E157CD7909F65AEAA7C0733D791376CD17B5421ED

Message: [Hello World!]

Signature length: [4627]
Signature (truncated to 500 bytes): (500 bytes): A6CBD1297B8A5B11F355C03E500D5F93CCD6F0AE3B5828687042070C322DE792DD0682FD4438AA9B7D1ECFF14139E4F4A0ED75A8E221E97336AF9F14DECA58BFEFE4CF28D5555C8143F0D874966A4D5EFE57584BA84BB708FFD98898C490BBB98B6E9926814BDB6EF3E9CA14D344EDEF4A691E1C917690CC31B1E646EE137FCEB66AC8BD8C20E3E310C7055AAA98B4A97D4C6F899634BE24626865C98A485622D5D132C9671EEAE002EBC9E6934C2F9BD4C9ECE7F39315D432DEA210467E24C126A5C9E75956B507A31DFB771451EF62FC5B442C9E40A50ECCE5604F75E899C2C5109BFD5012FB61555E0FBCA70D661F081F2B23E5F84179CAF597C4AF9EE0C11556A62DA9E4E178255BCED41EF9A8769355496E29712F86AACB3DD86E76AD35E4D6D4E43AB9C367DB1941CCBF98FAFD2387369BD53C68843E6500F64A0DF2DA7B33F6A077F0E39124BB55FED269CA206757A0841A0B77D01448BB59C2A889C6A43D1525FF18F7834941872B5DCEAF40DB660710EC89DD360B1555DB5DAEFE7A50FAA9E0A46F997689EA075D79B775824BCEC3B7B1B1740650E5CB33AD115E8894C1E8E5B0F376F7BCE2C0B80617081E9612529964153105E45F18AFC1C469C8094814EB583804EDA6530D2BC3354A7054472F1D77E3B1FBE5F7911AF4165196286E2EC743EB3E2203DAB57818E517FBAA5369EB

*/